<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FaceChain - Upload</title>
<style>
body { font-family: 'Inter', sans-serif; background: #101a23; color: white; margin:0; }
header { display:flex; justify-content: space-between; align-items: center; padding: 10px 40px; border-bottom: 1px solid #223649; }
header h2 { font-size: 1.25rem; font-weight: bold; }
nav a { margin-left:20px; text-decoration:none; color:white; font-weight:500; }
.btn { padding:10px 20px; margin:5px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; }
.btn-start { background:#223649; color:white; }
.btn-stop { background:#223649; color:white; }
.btn-submit { background:#0b80ee; color:white; }
video { border-radius:10px; margin:10px 0; }
input[type=file] { display:none; }
label { cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:10px; border:2px dashed #314d68; border-radius:10px; padding:20px; margin:10px 0; }
main { padding:20px 40px; }
input[type=text] { padding:8px; border-radius:5px; border:none; margin:5px 0; width:100%; }
</style>
</head>
<body>

<!-- Header / Nav -->
<header>
<h2>FaceChain</h2>
<nav>
<a href="index.html">Home</a>
<a href="upload.html">Upload</a>
<a href="authenticate.html">Authenticate</a>
</nav>
</header>

<main>
<h1>Upload Your Face</h1>
<p>Upload a clear photo or capture using your camera. Accepted formats: JPG, PNG. Maximum size: 5MB.</p>

<label>
  User ID:
  <input type="text" id="userIdInput" placeholder="Enter your User ID">
</label>

<!-- Live Camera -->
<video id="video" width="320" height="240" autoplay></video>
<div>
  <button class="btn btn-start" id="startBtn">Start Camera</button>
  <button class="btn btn-stop" id="stopBtn">Stop Camera</button>
  <button class="btn btn-submit" id="captureBtn">Capture & Upload</button>
</div>

<hr style="margin:20px 0; border-color:#223649;">

<!-- Image Upload -->
<label>
  <span>Drag & drop or click to select a file</span>
  <input type="file" id="fileInput" accept="image/*">
</label>
<button class="btn btn-submit" id="uploadBtn">Upload Image</button>

<p id="message"></p>
</main>

<script>
const video = document.getElementById('video');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const captureBtn = document.getElementById('captureBtn');
const fileInput = document.getElementById('fileInput');
const uploadBtn = document.getElementById('uploadBtn');
const message = document.getElementById('message');
const userIdInput = document.getElementById('userIdInput');
let stream = null;

// Start Camera
startBtn.onclick = async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video:true });
    video.srcObject = stream;
  } catch(err) {
    alert("Cannot access camera: " + err);
  }
};

// Stop Camera
stopBtn.onclick = () => {
  if(stream){
    stream.getTracks().forEach(track => track.stop());
    stream = null;
    video.srcObject = null;
  }
};

// Capture & Upload from Camera
captureBtn.onclick = async () => {
  const userId = userIdInput.value.trim();
  if(!userId) { alert("Enter User ID"); return; }
  if(!stream) { alert("Start camera first!"); return; }

  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth || 320;
  canvas.height = video.videoHeight || 240;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const image = canvas.toDataURL('image/png');

  try {
    const res = await fetch('http://127.0.0.1:5000/register', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ image, user_id: userId })
    });
    const data = await res.json();
    message.innerText = data.message || data.error;
  } catch(err){
    message.innerText = "Error: "+err;
  }
};

// Upload from File
uploadBtn.onclick = async () => {
  const userId = userIdInput.value.trim();
  if(!userId) { alert("Enter User ID"); return; }
  if(!fileInput.files[0]) { alert("Select a file first!"); return; }

  const file = fileInput.files[0];
  const reader = new FileReader();
  reader.onloadend = async () => {
    const image = reader.result;
    try{
      const res = await fetch('http://127.0.0.1:5000/register', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ image, user_id: userId })
      });
      const data = await res.json();
      message.innerText = data.message || data.error;
    } catch(err){
      message.innerText = "Error: "+err;
    }
  };
  reader.readAsDataURL(file);
};
</script>

</body>
</html>
