<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FaceChain - Admin Dashboard</title>
  <style>
    :root {
      --bg-dark: #0a0f14;
      --bg-panel: #16222e;
      --border-color: #223649;
      --text-main: #ffffff;
      --text-muted: #9daebe;
      --accent-red: #e02424;
      --accent-blue: #0b80ee;
      --accent-green: #059669;
    }

    body { font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text-main); margin: 0; }

    /* Header & Nav */
    header { display: flex; justify-content: space-between; align-items: center; padding: 15px 40px; background: #101a23; border-bottom: 2px solid var(--accent-red); }
    header h2 { color: var(--accent-red); margin: 0; display: flex; align-items: center; gap: 10px; font-size: 1.5rem; }
    .secure-tag { font-size: 0.75rem; background: var(--accent-red); color: white; padding: 2px 8px; border-radius: 4px; vertical-align: middle; }
    
    nav a { margin-left: 20px; text-decoration: none; color: var(--text-muted); font-weight: 500; transition: 0.3s; cursor: pointer; }
    nav a:hover { color: white; text-shadow: 0 0 5px rgba(255,255,255,0.2); }
    
    /* Layout */
    main { padding: 30px 40px; max-width: 1200px; margin: 0 auto; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
    
    /* Cards */
    .card { background: var(--bg-panel); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
    .card h3 { margin-top: 0; color: var(--accent-blue); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; font-size: 1.1rem; }
    
    .stat { font-size: 2rem; font-weight: bold; margin: 15px 0; }
    .label { color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .node-status { font-family: monospace; font-size: 0.85rem; color: var(--accent-green); margin-top: 15px; display: flex; align-items: center; gap: 8px; }
    
    /* Table */
    .table-container { overflow-x: auto; margin-top: 15px; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; color: var(--text-muted); font-size: 0.75rem; padding: 12px; border-bottom: 1px solid var(--border-color); text-transform: uppercase; }
    td { padding: 12px; font-size: 0.9rem; border-bottom: 1px solid #1a2632; color: #e1e7ef; }
    
    tr:hover td { background-color: #1c2b3a; }
    
    /* Buttons & Badges */
    .btn-action { background: var(--border-color); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; transition: background 0.2s; }
    .btn-action:hover { background: var(--accent-blue); }
    
    .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; }
    .badge-success { background: rgba(5, 150, 105, 0.2); color: #34d399; border: 1px solid #059669; }
    .badge-pending { background: rgba(245, 158, 11, 0.2); color: #fbbf24; border: 1px solid #d97706; }

    /* Utility */
    .error-msg { color: #f87171; background: rgba(220, 38, 38, 0.1); padding: 10px; border-radius: 6px; border: 1px solid #dc2626; display: none; margin-bottom: 20px; }
    .loading-pulse { animation: pulse 1.5s infinite; opacity: 0.7; }
    
    @keyframes pulse { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }
  </style>
</head>
<body>

  <header>
    <h2>üõ°Ô∏è FaceChain Admin <span class="secure-tag">SECURE</span></h2>
    <nav>
      <a href="index.html">View Site</a>
      <a href="upload.html">Registration</a>
      <a onclick="logout()">Logout</a>
    </nav>
  </header>

  <main>
    <div id="errorDisplay" class="error-msg"></div>

    <h1>System Overview</h1>
    <p style="color: var(--text-muted);">Manage decentralized identities and monitor blockchain authentication logs.</p>

    <div class="grid">
      <div class="card">
        <h3>Network Status</h3>
        <div class="stat">Connected</div>
        <div class="label">Local Node (Ganache)</div>
        <div class="node-status">
          <span style="height: 10px; width: 10px; background-color: var(--accent-green); border-radius: 50%; display: inline-block;"></span>
          http://127.0.0.1:7545
        </div>
      </div>

      <div class="card">
        <h3>Biometric Data</h3>
        <div id="userCount" class="stat loading-pulse">--</div>
        <div class="label">Total Registered Face Hashes</div>
      </div>

      <div class="card">
        <h3>EVM Status</h3>
        <div class="stat">Ready</div>
        <div class="label">Office Voting Machine Terminal</div>
        <button onclick="resetEVM()" class="btn-action" style="margin-top: 15px;">Reset EVM Lock</button>
      </div>
    </div>

    <div class="card" style="margin-top: 30px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>Recent Authentications (Blockchain Ledger)</h3>
        <button onclick="loadAdminData()" class="btn-action">‚Üª Refresh</button>
      </div>
      
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>User ID / Wallet</th>
              <th>Hash (SHA-256)</th>
              <th>Result</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="logTable">
            <tr><td colspan="5" style="text-align:center; padding: 20px;" class="loading-pulse">Syncing with ledger...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

<script>
  // Helper: Format Date nicely
  function formatTimestamp(isoString) {
    if (!isoString) return 'N/A';
    const date = new Date(isoString);
    return date.toLocaleString('en-IN', { 
      day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit', second: '2-digit' 
    });
  }

  // Helper: Show Error on screen instead of alert
  function showError(msg) {
    const el = document.getElementById('errorDisplay');
    el.innerText = `‚ö†Ô∏è Error: ${msg}`;
    el.style.display = 'block';
  }

  // Main Data Loader
  async function loadAdminData() {
    const tableBody = document.getElementById('logTable');
    const countEl = document.getElementById('userCount');
    const errEl = document.getElementById('errorDisplay');
    
    // Reset UI state
    errEl.style.display = 'none';
    tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px;" class="loading-pulse">Syncing with ledger...</td></tr>';
    countEl.classList.add('loading-pulse');

    try {
      // 1. Fetch Data
      const res = await fetch('http://127.0.0.1:5000/admin/stats', {
        method: 'GET',
        credentials: 'include' // Important for session cookies
      });

      // 2. Handle Auth Failure
      if (res.status === 401 || res.status === 403) {
        throw new Error("Unauthorized"); // Caught below to redirect
      }
      if (!res.ok) {
        throw new Error(`Server Error: ${res.status}`);
      }

      // 3. Process Data
      const data = await res.json();
      
      // Update Count
      countEl.classList.remove('loading-pulse');
      countEl.innerText = data.total_users || 0;

      // Update Table
      tableBody.innerHTML = ''; 

      if (data.logs && data.logs.length > 0) {
        data.logs.forEach(log => {
          // Determine badge color based on status text
          const badgeClass = (log.status && log.status.toLowerCase().includes('success')) 
            ? 'badge-success' : 'badge-pending';

          const row = `
            <tr>
              <td style="font-family:monospace; color: #9daebe;">${formatTimestamp(log.timestamp)}</td>
              <td style="font-weight:bold;">${log.user_id}</td>
              <td style="font-family: monospace; font-size: 0.8rem; color: #5dade2;">${log.hash_short || 'SHA-256 Verified'}</td>
              <td><span class="badge ${badgeClass}">${log.status}</span></td>
              <td><button class="btn-action" onclick="inspectLog('${log.id}')">Inspect</button></td>
            </tr>`;
          tableBody.innerHTML += row;
        });
      } else {
        tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: #9daebe; padding: 20px;">No recent authentication logs found.</td></tr>';
      }

    } catch (err) {
      console.error(err);
      if (err.message === "Unauthorized") {
        window.location.href = "authenticate.html";
      } else {
        countEl.innerText = "Err";
        countEl.classList.remove('loading-pulse');
        tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: #f87171;">Connection Failed. Check Console.</td></tr>';
        showError(err.message + " - Ensure Backend (Port 5000) is running.");
      }
    }
  }

  // Placeholder for EVM Reset
  async function resetEVM() {
    if(confirm("Are you sure you want to reset the EVM voting lock?")) {
      console.log("Sending reset command to Smart Contract...");
      // Add fetch call here later
      alert("EVM Reset Signal Sent.");
    }
  }

  // Placeholder for Log Inspection
  function inspectLog(logId) {
    console.log("Inspecting Log ID:", logId);
    alert(`Opening detailed blockchain trace for ID: ${logId}`);
  }

  async function logout() {
    try {
      await fetch('http://127.0.0.1:5000/logout', { credentials: 'include' });
      window.location.href = "authenticate.html";
    } catch (err) {
      console.error("Logout failed:", err);
      // Force redirect anyway
      window.location.href = "authenticate.html";
    }
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', loadAdminData);
</script>
</body>
</html>