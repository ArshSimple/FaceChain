<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FaceChain Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #0f172a; color: #cbd5e1; font-family: monospace; }
        .glass { background: rgba(30,41,59,0.7); border:1px solid rgba(148,163,184,0.1); backdrop-filter:blur(10px); }
        ::-webkit-scrollbar { width:8px; } ::-webkit-scrollbar-thumb { background:#334155; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">
    <aside class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col p-4">
        <h1 class="text-2xl font-bold text-white mb-8">FACE<span class="text-blue-500">CHAIN</span></h1>
        <nav class="space-y-2 mb-auto">
            <div class="px-4 py-2 bg-blue-500/10 text-blue-400 rounded border border-blue-500/20 text-xs font-bold">DASHBOARD</div>
            <a href="/" class="block px-4 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded text-xs font-bold transition">üëÅÔ∏è STUDENT VIEW</a>
        </nav>
        <button onclick="logout()" class="w-full py-2 bg-red-900/20 text-red-400 border border-red-900/30 rounded text-xs font-bold hover:bg-red-900/40">LOGOUT</button>
    </aside>

    <main class="flex-1 flex flex-col">
        <header class="h-16 border-b border-slate-800 flex items-center justify-between px-8 bg-slate-900">
            <div class="text-xs font-bold text-emerald-500">‚óè SYSTEM ONLINE</div>
            <button onclick="loadData()" class="text-xs bg-slate-800 text-white px-3 py-1 rounded border border-slate-600 hover:bg-slate-700">REFRESH DATA</button>
        </header>

        <div class="flex-1 overflow-y-auto p-8 space-y-6">
            
            <div class="glass p-6 rounded">
                <h3 class="font-bold text-white mb-4">üìÖ Scheduler</h3>
                <div class="flex gap-4 mb-4">
                    <select id="sched-subject" class="bg-slate-950 border border-slate-700 text-white p-2 rounded w-1/3 text-xs">
                        <option>Network Security</option><option>Blockchain</option><option>AI/ML</option>
                    </select>
                    <input type="date" id="sched-date" class="bg-slate-950 border border-slate-700 text-white p-2 rounded w-1/3 text-xs">
                    <button onclick="setSchedule()" class="bg-blue-600 text-white px-6 rounded font-bold text-xs">Set Schedule</button>
                </div>
                <div id="schedule-list" class="space-y-2"></div>
            </div>

            <div class="glass p-6 rounded h-[500px] flex flex-col">
                <div class="flex justify-between mb-4">
                    <h3 class="font-bold text-white">üéì Students Registry</h3>
                    <input type="text" id="userSearch" onkeyup="filterUsers()" placeholder="Search Name/Roll..." class="bg-slate-950 border border-slate-700 text-white px-2 rounded text-xs w-64">
                </div>
                <div class="overflow-y-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-900 text-slate-500 text-xs uppercase sticky top-0">
                            <tr>
                                <th class="p-3">Name</th>
                                <th class="p-3">Roll No</th>
                                <th class="p-3">Exam Status / Manage</th>
                                <th class="p-3">MFA Control</th> 
                                <th class="p-3 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody" class="divide-y divide-slate-800"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="glass p-6 rounded">
                <h3 class="font-bold text-white mb-2">üõ°Ô∏è Security Logs</h3>
                <div id="logs-container" class="bg-black h-48 overflow-y-auto p-4 text-xs font-mono text-slate-500"></div>
            </div>
        </div>
    </main>

    <script>
        let allUsers = [];
        async function loadData() {
            try {
                let res = await fetch(`/admin/stats?t=${Date.now()}`);
                if(res.status===401) return window.location.href="index.html";
                let data = await res.json();
                allUsers = data.user_list||[];
                renderUsers(allUsers); renderSchedule(data.schedule); renderLogs(data.logs);
            } catch(e){}
        }

        function renderUsers(users) {
            document.getElementById('userTableBody').innerHTML = users.map(u => {
                let status = u.exam_subjects.map(s => {
                    let verified = u.exams_verified && u.exams_verified.includes(s);
                    let color = verified ? "bg-blue-500/10 text-blue-400 border-blue-500/30" : "bg-slate-800 text-slate-500 border-slate-700";
                    let icon = verified ? "‚úì" : "‚óã";
                    // Click to REMOVE Exam
                    return `<button onclick="manageExam('${u.id}', '${s}', 'remove')" class="px-2 py-1 text-[10px] border rounded mr-1 ${color} hover:bg-red-900 hover:text-white" title="Click to Remove Exam">${s} ${icon}</button>`;
                }).join('');

                // Add Exam Button
                let addBtn = `<button onclick="promptAddExam('${u.id}')" class="px-2 py-1 text-[10px] border border-slate-600 rounded bg-slate-800 hover:bg-blue-600 text-slate-400 hover:text-white">+ Add</button>`;

                let mfaClass = u.mfa_enabled ? "bg-emerald-500/10 text-emerald-400 border-emerald-500/30" : "bg-slate-700 text-slate-400 border-slate-600";
                let mfaText = u.mfa_enabled ? "ENABLED" : "DISABLED";

                return `
                <tr class="hover:bg-slate-800/50">
                    <td class="p-3 font-bold text-white">${u.name}</td>
                    <td class="p-3 font-mono text-blue-400">${u.roll_no}</td>
                    <td class="p-3">${status} ${addBtn}</td>
                    <td class="p-3"><button onclick="toggleMFA('${u.id}')" class="text-[10px] font-bold px-2 py-1 rounded border ${mfaClass}">${mfaText}</button></td>
                    <td class="p-3 text-right">${u.id!=='1' ? `<button onclick="deleteUser('${u.id}')" class="text-xs text-red-400 bg-red-900/20 px-2 py-1 rounded hover:bg-red-900/40 border border-red-900/30">DELETE</button>` : '<span class="text-xs text-slate-600">Admin</span>'}</td>
                </tr>`;
            }).join('');
        }

        function renderSchedule(sched) {
            let html = ""; for(let [s,d] of Object.entries(sched)) { html += `<div class="flex justify-between items-center bg-slate-900 p-2 rounded border border-slate-800"><span class="text-white text-sm font-bold">${s}</span><span class="text-emerald-400 font-mono text-xs">${d}</span><button onclick="delSchedule('${s}')" class="text-red-500 text-xs hover:text-white">x</button></div>`; }
            document.getElementById('schedule-list').innerHTML = html;
        }

        function renderLogs(logs) {
            document.getElementById('logs-container').innerHTML = logs.map(l => `<div class="mb-1 border-b border-slate-900 pb-1"><span class="text-slate-600">[${l.timestamp}]</span> <span class="${l.status==='SUCCESS'||l.status==='VERIFIED'?'text-emerald-400':'text-red-400'}">${l.action} : ${l.status}</span> <span class="text-slate-500">(${l.user_id})</span></div>`).join('');
        }

        async function manageExam(uid, sub, action) {
            if(confirm(`${action.toUpperCase()} exam '${sub}' for user ${uid}?`)) {
                await fetch('/admin/manage_user_exams', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: uid, subject: sub, action: action})
                });
                loadData();
            }
        }

        async function promptAddExam(uid) {
            let sub = prompt("Enter Subject Name to Add (e.g. AI/ML, Blockchain):");
            if(sub) manageExam(uid, sub, 'add');
        }

        async function setSchedule() { let s = document.getElementById('sched-subject').value; let d = document.getElementById('sched-date').value; if(!d) return; await fetch('/admin/set_schedule', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({subject:s, date:d})}); loadData(); }
        async function delSchedule(s) { if(confirm('Delete Schedule?')) { await fetch('/admin/delete_schedule', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({subject:s})}); loadData(); } }
        async function deleteUser(id) { if(confirm('Delete User?')) { await fetch('/admin/user_ops', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user_id:id, action:'delete'}) }); loadData(); } }
        async function toggleMFA(id) { await fetch('/admin/user_ops', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user_id:id, action:'toggle_mfa'}) }); loadData(); }
        function filterUsers() { let t = document.getElementById('userSearch').value.toLowerCase(); renderUsers(allUsers.filter(u => u.name.toLowerCase().includes(t) || u.roll_no.toLowerCase().includes(t))); }
        async function logout() { await fetch('/logout'); window.location.href="index.html"; }
        
        loadData(); setInterval(loadData, 5000);
    </script>
</body>
</html>