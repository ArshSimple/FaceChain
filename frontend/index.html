<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FaceChain Secure Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        .hidden-section { display: none !important; }
        .mirror-mode { transform: scaleX(-1); }
        
        /* Exam Results Styling */
        .correct-block { background-color: rgba(16, 185, 129, 0.1); border-left: 4px solid #10b981; }
        .wrong-block { background-color: rgba(239, 68, 68, 0.1); border-left: 4px solid #ef4444; }
        .correct-option-highlight { background-color: rgba(16, 185, 129, 0.2); border: 1px solid #10b981; font-weight: bold; }

        /* Warning Toast Animation */
        @keyframes flashRed { 0% { background-color: #ef4444; } 50% { background-color: #7f1d1d; } 100% { background-color: #ef4444; } }
        .warning-active { animation: flashRed 1s infinite; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen">
    <nav class="bg-slate-800 p-4 border-b border-slate-700 flex justify-between items-center sticky top-0 z-50">
        <h1 class="font-bold text-xl text-white">FACECHAIN <span class="text-blue-400">SECURE</span></h1>
        <button onclick="logout()" class="text-sm text-slate-400 hover:text-white">logout</button>
    </nav>

    <div class="max-w-5xl mx-auto p-6 mt-8">
        
        <div id="section-home" class="text-center py-10">
            <h2 class="text-5xl font-bold text-white mb-10">Examination Portal</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div onclick="showSection('section-register')" class="bg-slate-800 p-10 rounded-2xl border border-slate-700 hover:border-blue-500 cursor-pointer shadow-lg">
                    <div class="text-5xl mb-4">üìù</div>
                    <h3 class="text-2xl font-bold text-white">New Student</h3>
                    <p class="text-slate-400">Register with Roll No & Face ID</p>
                </div>
                <div onclick="showSection('section-login')" class="bg-slate-800 p-10 rounded-2xl border border-slate-700 hover:border-emerald-500 cursor-pointer shadow-lg">
                    <div class="text-5xl mb-4">üîê</div>
                    <h3 class="text-2xl font-bold text-white">Student Login</h3>
                    <p class="text-slate-400">Enter Exam Hall</p>
                </div>
            </div>
        </div>

        <div id="section-register" class="hidden-section bg-slate-800 p-8 rounded-2xl border border-slate-700 max-w-3xl mx-auto">
            <h2 class="text-2xl font-bold text-white mb-6">üìù Student Registration</h2>
            <div class="space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="reg-roll" placeholder="Roll Number (User ID)" class="bg-slate-900 border border-slate-600 rounded p-3 text-white">
                    <input type="text" id="reg-name" placeholder="Full Name" class="bg-slate-900 border border-slate-600 rounded p-3 text-white">
                </div>
                <div class="bg-slate-900 p-4 rounded border border-slate-700">
                    <label class="block mb-2 font-bold text-slate-400">Subjects:</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2"><input type="checkbox" class="subject-cb" value="Blockchain"> Blockchain</label>
                        <label class="flex items-center gap-2"><input type="checkbox" class="subject-cb" value="Network Security"> Net Sec</label>
                        <label class="flex items-center gap-2"><input type="checkbox" class="subject-cb" value="AI/ML"> AI/ML</label>
                    </div>
                </div>
                
                <div>
                    <div class="flex gap-2 mb-2">
                        <button onclick="toggleInput('camera')" class="px-4 py-1 bg-blue-600 text-white rounded text-sm">Webcam</button>
                        <button onclick="toggleInput('upload')" class="px-4 py-1 bg-slate-700 text-slate-300 rounded text-sm">Upload</button>
                    </div>
                    <div id="camera-container" class="relative bg-black rounded-lg overflow-hidden h-64 border border-slate-600">
                        <video id="video" class="w-full h-full object-cover mirror-mode" autoplay playsinline></video>
                        <canvas id="canvas" class="hidden-section"></canvas>
                    </div>
                    <div id="upload-container" class="hidden-section bg-slate-900 border-2 border-dashed border-slate-600 rounded-lg h-64 flex flex-col items-center justify-center cursor-pointer" onclick="document.getElementById('file-upload').click()">
                        <input type="file" id="file-upload" accept="image/*" class="hidden" onchange="handleFileUpload(this)">
                        <img id="preview-img" class="h-full w-full object-contain hidden-section">
                        <div id="upload-placeholder" class="text-slate-500">Click to Upload Image</div>
                    </div>
                    <button onclick="captureFace()" id="btn-capture" class="mt-2 w-full bg-slate-700 hover:bg-slate-600 text-white py-2 rounded">Capture</button>
                    <p id="capture-status" class="hidden-section text-center text-emerald-400 mt-2">‚úÖ Photo Ready</p>
                </div>

                <div class="flex gap-4">
                    <button onclick="location.reload()" class="w-1/3 bg-slate-700 text-white py-3 rounded">Cancel</button>
                    <button onclick="registerUser()" class="w-2/3 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded">Register</button>
                </div>
            </div>
        </div>

        <div id="section-login" class="hidden-section bg-slate-800 p-8 rounded-2xl border border-slate-700 max-w-lg mx-auto">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">üîê Biometric Login</h2>
            <div class="space-y-6">
                <div>
                    <label class="block text-slate-400 mb-2">Roll Number</label>
                    <input type="text" id="login-roll" placeholder="Enter Roll No" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-white">
                </div>
                
                <div class="relative bg-black rounded-lg overflow-hidden h-64 border border-emerald-600 shadow-lg shadow-emerald-900/20">
                    <video id="login-video" class="w-full h-full object-cover mirror-mode" autoplay playsinline></video>
                    <div class="absolute inset-0 border-2 border-emerald-500/30 m-8 rounded-lg pointer-events-none"></div>
                </div>

                <div class="flex gap-4">
                    <button onclick="location.reload()" class="w-1/3 bg-slate-700 text-white py-3 rounded">Back</button>
                    <button onclick="performLogin()" class="w-2/3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded">Authenticate</button>
                </div>
            </div>
        </div>

        <div id="mfa-popup" class="hidden-section fixed inset-0 bg-black/90 flex items-center justify-center z-50">
            <div class="bg-slate-900 p-8 rounded-2xl border border-slate-700 text-center">
                <h3 class="text-2xl font-bold text-white mb-4">Setup 2FA</h3>
                <div class="bg-white p-4 rounded inline-block mb-4"><div id="qrcode"></div></div>
                <button onclick="location.reload()" class="block w-full bg-emerald-600 text-white py-2 rounded">Done</button>
            </div>
        </div>

        <div id="section-exam" class="hidden-section bg-slate-800 p-8 rounded-2xl border border-slate-700 relative">
            
            <div id="monitor-alert" class="hidden-section absolute top-4 right-4 bg-red-600 text-white p-4 rounded shadow-lg z-50 max-w-xs animate-pulse">
                <p class="font-bold">‚ö†Ô∏è PROCTORING ALERT</p>
                <p id="monitor-msg" class="text-sm mt-1">Face not detected!</p>
            </div>

            <div id="monitor-box" class="hidden-section fixed bottom-4 right-4 w-40 h-32 bg-black border-2 border-slate-500 rounded-lg overflow-hidden shadow-2xl z-50">
                <video id="monitor-video" class="w-full h-full object-cover mirror-mode" autoplay playsinline muted></video>
                <div class="absolute bottom-0 w-full bg-black/50 text-xs text-center text-white py-1">Proctoring Active</div>
            </div>

            <div class="flex justify-between items-center border-b border-slate-700 pb-4 mb-6">
                <h2 class="text-2xl font-bold text-white">Student Dashboard</h2>
                <div class="text-right">
                    <p class="text-slate-400">Roll No: <span id="student-id-display" class="text-blue-400 font-mono">--</span></p>
                </div>
            </div>
            
            <div id="exam-list" class="space-y-4"></div>
            
            <div id="active-exam-paper" class="hidden-section mt-8 pt-6 border-t border-slate-700">
                <h3 id="paper-title" class="text-3xl font-bold text-white mb-4"></h3>
                <div id="questions-container" class="space-y-6"></div>
                <div class="mt-8 flex gap-4">
                    <button id="btn-submit" onclick="submitExam()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded">Submit Exam</button>
                    <button id="btn-close" onclick="closeExam()" class="hidden-section w-full bg-slate-700 text-white py-3 rounded">Return to List</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "http://127.0.0.1:5000";
        let capturedImage = null;
        let examSchedule = {};
        let monitoringInterval = null; 
        let completedExams = new Set(); // Track finished exams

        const QUESTION_BANK = {
            "Blockchain": [
                { q: "What is the genesis block?", options: ["First block", "Last block", "Orphan block"], ans: "First block" },
                { q: "Which consensus is PoW?", options: ["Proof of Work", "Proof of Stake", "Proof of Auth"], ans: "Proof of Work" },
                { q: "Smart Contracts are stored on?", options: ["Server", "Blockchain", "Client"], ans: "Blockchain" }
            ],
            "Network Security": [
                { q: "HTTPS Port?", options: ["80", "443", "22"], ans: "443" },
                { q: "What is Phishing?", options: ["Fake Site", "Virus", "Trojan"], ans: "Fake Site" },
                { q: "SSL stands for?", options: ["Secure Socket Layer", "System Layer", "Speed Layer"], ans: "Secure Socket Layer" }
            ],
            "AI/ML": [
                { q: "Supervised learning uses?", options: ["Labeled Data", "Unlabeled Data"], ans: "Labeled Data" },
                { q: "Library for Deep Learning?", options: ["React", "TensorFlow", "Pandas"], ans: "TensorFlow" }
            ]
        };

        // --- NAVIGATION & CAMERA CONTROL ---

        function stopAllCameras() {
            document.querySelectorAll('video').forEach(vid => {
                if(vid.srcObject) {
                    vid.srcObject.getTracks().forEach(track => track.stop());
                    vid.srcObject = null;
                }
            });
            stopMonitoring(); 
        }

        function showSection(id) {
            stopAllCameras();
            document.querySelectorAll('.hidden-section').forEach(el => el.classList.add('hidden-section'));
            document.querySelectorAll('[id^="section-"]').forEach(el => el.classList.add('hidden-section'));
            document.getElementById(id).classList.remove('hidden-section');
            
            if(id === 'section-register') toggleInput('camera');
            if(id === 'section-login') startLoginCamera();
        }

        function logout() { 
            stopMonitoring();
            fetch('/logout').then(() => location.reload());
        }

        // --- MONITORING LOGIC ---

        function startMonitoring() {
            console.log("Starting Exam Proctoring...");
            document.getElementById('monitor-box').classList.remove('hidden-section'); // Show the box
            
            navigator.mediaDevices.getUserMedia({video: true}).then(stream => {
                document.getElementById('monitor-video').srcObject = stream;
                
                // Check face every 5 seconds
                monitoringInterval = setInterval(async () => {
                    checkFacePresence();
                }, 5000); 
            }).catch(e => console.error("Proctoring Camera Failed", e));
        }

        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            document.getElementById('monitor-box').classList.add('hidden-section'); // Hide the box
            let mv = document.getElementById('monitor-video');
            if(mv.srcObject) mv.srcObject.getTracks().forEach(t => t.stop());
        }

        async function checkFacePresence() {
            let v = document.getElementById('monitor-video');
            if (!v.srcObject) return;

            let c = document.createElement('canvas');
            c.width = v.videoWidth; c.height = v.videoHeight;
            c.getContext('2d').drawImage(v, 0, 0);
            let img = c.toDataURL('image/jpeg');

            try {
                let res = await fetch(`${API_URL}/monitor_exam`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ image: img })
                });
                let data = await res.json();
                let alertBox = document.getElementById('monitor-alert');
                let alertMsg = document.getElementById('monitor-msg');

                if (data.success) {
                    alertBox.classList.add('hidden-section');
                } else {
                    alertMsg.innerText = data.message;
                    alertBox.classList.remove('hidden-section');
                }
            } catch (e) {
                console.log("Monitoring Error (Ignored)");
            }
        }

        // --- EXAM LOGIC ---

        function renderExamList(subs) {
            let list = document.getElementById('exam-list'); list.innerHTML="";
            let today = new Date().toISOString().split('T')[0];
            subs.forEach(s => {
                let date = examSchedule[s] || "TBA";
                let isCompleted = completedExams.has(s); // Check if exam is done
                
                let btn = "bg-slate-700 text-slate-500 cursor-not-allowed";
                let disabled = "disabled";
                let badge = `<span class="text-slate-500">Scheduled: ${date}</span>`;
                let btnText = "Start";

                if (isCompleted) {
                    btn = "bg-emerald-900 text-emerald-500 border border-emerald-700 cursor-not-allowed";
                    btnText = "Completed";
                    badge = `<span class="text-emerald-500 font-bold">‚úî Submitted</span>`;
                } else if (date === today) {
                    btn = "bg-blue-600 hover:bg-blue-500 text-white shadow";
                    disabled = "";
                    badge = `<span class="text-emerald-400 font-bold">‚óè LIVE NOW</span>`;
                }

                list.innerHTML += `
                    <div class="bg-slate-900 p-4 rounded border border-slate-700 flex justify-between items-center">
                        <div><h4 class="font-bold text-white">${s}</h4><div class="text-sm">${badge}</div></div>
                        <button onclick="startExam('${s}')" ${disabled} class="px-6 py-2 rounded ${btn}">${btnText}</button>
                    </div>`;
            });
        }

        async function startExam(sub) {
            stopMonitoring(); // Reset monitoring to be safe
            
            await fetch(`${API_URL}/mark_exam_verified`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ subject: sub })
            });

            // Start Monitoring (Auto-Restart)
            startMonitoring();

            let qs = QUESTION_BANK[sub] || [];
            document.getElementById('exam-list').classList.add('hidden-section');
            document.getElementById('active-exam-paper').classList.remove('hidden-section');
            document.getElementById('paper-title').innerText = sub;
            let c = document.getElementById('questions-container'); c.innerHTML="";
            
            // Render Questions
            qs.forEach((q,i) => {
                let opts = q.options.map(o => `
                    <label class="block bg-slate-900 p-3 rounded mb-2 cursor-pointer border border-slate-700 hover:border-blue-500 transition">
                        <input type="radio" name="q${i}" value="${o}" class="mr-2 accent-blue-500"> ${o}
                    </label>`).join('');
                
                c.innerHTML += `
                    <div class="q-block bg-slate-800 p-6 rounded border border-slate-700" data-ans="${q.ans}">
                        <p class="font-bold text-white mb-4">Q${i+1}. ${q.q}</p>
                        ${opts}
                    </div>`;
            });
            document.getElementById('btn-submit').classList.remove('hidden-section');
            document.getElementById('btn-close').classList.add('hidden-section');
        }

        function submitExam() {
            stopMonitoring(); // Stop monitoring when done
            
            // Mark Exam as Completed
            let currentSubject = document.getElementById('paper-title').innerText;
            completedExams.add(currentSubject);

            let score=0; 
            let blocks=document.querySelectorAll('.q-block');
            
            blocks.forEach(b => {
                let ans = b.dataset.ans; // Correct Answer
                let inps = b.querySelectorAll('input');
                let userSelected = null;
                
                // 1. Find what user selected & Disable all
                inps.forEach(i => { 
                    if(i.checked) userSelected = i.value; 
                    i.disabled = true; 
                });

                // 2. Visual Grading Logic
                if (userSelected === ans) {
                    score++;
                    b.classList.add('correct-block'); // Green Border
                } else {
                    if(userSelected) b.classList.add('wrong-block'); // Red Border
                    // Highlight correct answer
                    inps.forEach(i => {
                        if (i.value === ans) {
                            i.parentElement.classList.add('correct-option-highlight');
                            let span = document.createElement('span');
                            span.innerText = " ‚úÖ Correct Answer";
                            span.className = "text-emerald-400 font-bold text-sm ml-2";
                            i.parentElement.appendChild(span);
                        }
                    });
                }
            });

            alert(`Exam Submitted!\nScore: ${score}/${blocks.length}`);
            document.getElementById('btn-submit').classList.add('hidden-section');
            document.getElementById('btn-close').classList.remove('hidden-section');
        }

        function closeExam() {
            document.getElementById('active-exam-paper').classList.add('hidden-section');
            document.getElementById('exam-list').classList.remove('hidden-section');
            if(window.studentSubjects) renderExamList(window.studentSubjects);
        }

        // --- AUTH & COMMON UTILS ---

        async function verifyMFA(uid, code) {
            let res = await fetch(`${API_URL}/verify-mfa`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user_id:uid, code:code})});
            let data = await res.json();
            if(data.success) {
                examSchedule = data.schedule;
                window.studentSubjects = data.exam_subjects; 
                document.getElementById('student-id-display').innerText = uid;
                
                if(data.role === 'admin') {
                    if(confirm("Admin Login: Go to Dashboard? (Cancel to view Exam Portal)")) { 
                        window.location.href="admin_dashboard.html"; 
                    } else { 
                        renderExamList(window.studentSubjects); 
                        showSection('section-exam'); 
                    }
                } else { 
                    renderExamList(window.studentSubjects); 
                    showSection('section-exam'); 
                }
            } else alert("Invalid Code");
        }

        function toggleInput(mode) { 
            if(mode==='camera'){
                document.getElementById('camera-container').classList.remove('hidden-section');
                document.getElementById('upload-container').classList.add('hidden-section');
                document.getElementById('btn-capture').classList.remove('hidden-section');
                navigator.mediaDevices.getUserMedia({video:true}).then(s=>document.getElementById('video').srcObject=s);
            } else {
                document.getElementById('camera-container').classList.add('hidden-section');
                document.getElementById('upload-container').classList.remove('hidden-section');
                document.getElementById('btn-capture').classList.add('hidden-section');
                stopAllCameras();
            }
        }

        function captureFace() { 
            let v=document.getElementById('video'); 
            let c=document.getElementById('canvas'); 
            c.width=v.videoWidth; c.height=v.videoHeight;
            c.getContext('2d').drawImage(v,0,0);
            capturedImage=c.toDataURL('image/jpeg');
            document.getElementById('capture-status').classList.remove('hidden-section');
        }

        function handleFileUpload(input) { 
            let r=new FileReader();
            r.onload=e=>{
                capturedImage=e.target.result;
                document.getElementById('preview-img').src=capturedImage;
                document.getElementById('preview-img').classList.remove('hidden-section');
                document.getElementById('upload-placeholder').classList.add('hidden-section');
                document.getElementById('capture-status').classList.remove('hidden-section');
            };
            r.readAsDataURL(input.files[0]);
        }

        function startLoginCamera() { 
            navigator.mediaDevices.getUserMedia({video:true})
                .then(s=>document.getElementById('login-video').srcObject=s)
                .catch(e=>alert("Camera Denied"));
        }

        async function performLogin() { 
            let roll=document.getElementById('login-roll').value;
            if(!roll)return alert("Enter Roll");
            
            let v=document.getElementById('login-video');
            let c=document.createElement('canvas');
            c.width=v.videoWidth; c.height=v.videoHeight;
            c.getContext('2d').drawImage(v,0,0);
            let img=c.toDataURL('image/jpeg');
            
            try {
                let r=await fetch(`${API_URL}/authenticate`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:roll,image:img})});
                let d=await r.json();
                if(d.match){
                    stopAllCameras();
                    let c=d.mfa_required?prompt("MFA Code:"):"000000";
                    if(c)verifyMFA(roll,c);
                } else alert("‚ùå Face Mismatch or User Not Found");
            } catch(e){
                alert("Server Error");
            }
        }

        async function registerUser() { 
            let roll=document.getElementById('reg-roll').value;
            let name=document.getElementById('reg-name').value;
            let subs=Array.from(document.querySelectorAll('.subject-cb:checked')).map(c=>c.value);
            
            if(!roll||!capturedImage)return alert("Fill Data");
            
            let r=await fetch(`${API_URL}/register`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:roll,name:name,roll_no:roll,exam_subjects:subs,image:capturedImage})});
            let d=await r.json();
            
            if(d.mfa_uri){
                document.getElementById('qrcode').innerHTML="";
                new QRCode(document.getElementById('qrcode'),d.mfa_uri);
                document.getElementById('mfa-popup').classList.remove('hidden-section');
            } else alert(d.message);
        }
    </script>
</body>
</html>